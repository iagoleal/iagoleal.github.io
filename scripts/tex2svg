#!/usr/bin/env bash
DIR=$(dirname -- "$( realpath -- "$0")")

CACHEDIR=cache

if [ "$1" = "-" ]; then
  INFILE=/dev/stdin
else
  INFILE="$1"
fi
if [ "$2" = "-" ]; then
  OUTFILE=/dev/stdout
else
  OUTFILE="$2"
fi

TMPDIR="$(mktemp --directory --tmpdir tex2svg.XXXXXXXXXX)"

# TMPFILE="${TMPDIR}/$(sha1sum "$INFILE" | awk '{print $1}')"
TMPFILE="$TMPDIR/$(basename "$INFILE")"


cp "$INFILE" "${TMPFILE}.tex"
# tex -> dvi
lualatex --output-format=dvi --halt-on-error --interaction nonstopmode --output-directory "$TMPDIR" "${TMPFILE}.tex"
# dvi -> svg
dvisvgm --scale=2 --optimize=all --font-format=woff2 --exact -o "${TMPFILE}.svg" "${TMPFILE}.dvi"
# Generate output file
cp "${TMPFILE}.svg" "$OUTFILE"
# $DIR/svg-minify "${TMPFILE}.svg" "$OUTFILE"

## Currently unused
# pdftocairo -svg "${TMPFILE}.pdf" "${TMPFILE}.svg"
